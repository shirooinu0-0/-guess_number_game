import gradio as gr
import random

class TripleModeGame:
    def __init__(self):
        self.colors = ["ğŸ”´ ç´…è‰²", "ğŸŸ¡ é»ƒè‰²", "ğŸ”µ è—è‰²", "ğŸŸ¢ ç¶ è‰²", "ğŸŸ£ ç´«è‰²"]
        self.max_stamina = 7
        self.reset("ç¶“å…¸ç”Ÿå­˜æˆ°", 7)

    def reset(self, mode, max_stamina):
        self.mode = mode
        self.max_stamina = int(max_stamina)
        self.stamina = self.max_stamina
        self.target = random.randint(1, 100)
        self.low, self.high = 1, 100
        
        # å±¬æ€§è§£ç¢¼æˆ°å°ˆç”¨æ¨™è¨˜
        self.property_guessed = False 
        self.target_property = "å¶æ•¸" if self.target % 2 == 0 else "å¥‡æ•¸"

        if mode == "è‰²å½©åµæŸ¥æˆ°":
            start = max(1, self.target - random.randint(5, 20))
            self.num_range = list(range(start, min(101, start + 30)))
            self.color_map = {n: random.choice(self.colors) for n in self.num_range}
            self.target_color = self.color_map[self.target]

        return self.get_ui_status()

    def get_ui_status(self):
        heart_icons = "â¤ï¸" * max(0, self.stamina)
        status = f"â¤ï¸ å‰©é¤˜é«”åŠ›ï¼š{heart_icons} ({self.stamina}/{self.max_stamina})\n"
        status += f"ğŸ“ ç›®å‰ç¯„åœï¼š{self.low} ~ {self.high}\n"
        status += "="*30 + "\n"

        if self.mode == "ç¶“å…¸ç”Ÿå­˜æˆ°":
            status += "ã€æ¨¡å¼ï¼šç¶“å…¸ã€‘ç´”ç²¹çš„é‚è¼¯ï¼Œæ²’æœ‰é¡å¤–ç·šç´¢ã€‚"
        elif self.mode == "å±¬æ€§è§£ç¢¼æˆ°":
            if not self.property_guessed:
                status += "ã€æ¨¡å¼ï¼šå±¬æ€§ã€‘ç¬¬ä¸€æ­¥ï¼šè«‹å…ˆåœ¨å³å´é¸æ“‡å¥‡å¶æ•¸ã€‚\n(æ³¨æ„ï¼šé¦–å›åˆçŒœéŒ¯æ‰£ 2 é¡†å¿ƒï¼)"
            else:
                status += f"ã€æ¨¡å¼ï¼šå±¬æ€§ã€‘æƒ…å ±ç¢ºèªï¼šç›®æ¨™æ˜¯ä¸€å€‹ã€ {self.target_property} ã€‘"
        elif self.mode == "è‰²å½©åµæŸ¥æˆ°":
            status += f"ã€æ¨¡å¼ï¼šè‰²å½©ã€‘ç›®æ¨™é¡è‰²æ˜¯ï¼šã€ {self.target_color} ã€‘\n"
            status += "ğŸš¨ æ³¨æ„ï¼šæœ¬æ¨¡å¼é›£åº¦è¼ƒé«˜ï¼Œæ¯æ¬¡çŒœéŒ¯æ•¸å­—å°‡æ‰£é™¤ 2 é¡†å¿ƒï¼\n"
            matrix_str = "".join([f"{n:3d}:{self.color_map[n]}  " + ("\n" if (i+1)%5==0 else "") for i, n in enumerate(self.num_range)])
            status += "--- å€åŸŸè‰²å½©çŸ©é™£ ---\n" + matrix_str

        return status

game = TripleModeGame()

def play_engine(guess_num, mode, max_stamina, odd_even_guess):
    if game.mode != mode or game.max_stamina != int(max_stamina):
        game.reset(mode, max_stamina)
        return "æ¨¡å¼/é›£åº¦å·²åˆ‡æ›ï¼ŒéŠæˆ²é‡ç½®ï¼", game.get_ui_status()

    # å±¬æ€§è§£ç¢¼æˆ°é¦–è¼ªé‚è¼¯
    if mode == "å±¬æ€§è§£ç¢¼æˆ°" and not game.property_guessed:
        game.property_guessed = True
        if odd_even_guess == game.target_property:
            return f"âœ… é æ¸¬æ­£ç¢ºï¼ç›®æ¨™ç¢ºå¯¦æ˜¯ {game.target_property}ã€‚", game.get_ui_status()
        else:
            game.stamina -= 2
            if game.stamina <= 0:
                msg = f"ğŸ’€ é æ¸¬å¤±æ•—ä¸”é«”åŠ›è€—ç›¡ï¼ç­”æ¡ˆæ˜¯ {game.target}ã€‚"
                game.reset(mode, max_stamina)
                return msg, game.get_ui_status()
            return f"âŒ é æ¸¬éŒ¯èª¤ï¼æ‰£é™¤ 2 é¡†å¿ƒã€‚ç›®æ¨™å…¶å¯¦æ˜¯ {game.target_property}ã€‚", game.get_ui_status()

    if guess_num is None:
        return "è«‹è¼¸å…¥æ•¸å­—ï¼", game.get_ui_status()

    guess = int(guess_num)
    if guess == game.target:
        msg = f"ğŸ† æ­å–œï¼æ­£ç¢ºç­”æ¡ˆå°±æ˜¯ {game.target}ï¼"
        game.reset(mode, max_stamina)
        return msg, game.get_ui_status()

    # è‰²å½©åµæŸ¥æˆ°æ‰£é™¤ 2 é¡†å¿ƒï¼Œå…¶é¤˜æ¨¡å¼æ‰£ 1 é¡†
    penalty = 2 if mode == "è‰²å½©åµæŸ¥æˆ°" else 1
    game.stamina -= penalty
    
    if game.stamina <= 0:
        msg = f"ğŸ’€ å¤±æ•—ï¼ç­”æ¡ˆæ˜¯ {game.target}ã€‚"
        game.reset(mode, max_stamina)
        return msg, game.get_ui_status()

    # æç¤ºèªèˆ‡è¡€é‡æ‰£é™¤èªªæ˜
    penalty_msg = " (æ­¤æ¨¡å¼çŒœéŒ¯æ‰£ 2 é¡†å¿ƒ)" if mode == "è‰²å½©åµæŸ¥æˆ°" else ""
    if guess < game.target:
        game.low = max(game.low, guess + 1)
        res = f"ğŸ”» å¤ªå°äº†ï¼{penalty_msg}"
    else:
        game.high = min(game.high, guess - 1)
        res = f"ğŸ”º å¤ªå¤§äº†ï¼{penalty_msg}"

    return res, game.get_ui_status()

# å»ºç«‹ GUI
with gr.Blocks(title="é€²åŒ–ç‰ˆçŒœæ•¸å­—ï¼šä¸‰ä½ä¸€é«”") as demo:
    gr.Markdown("# ğŸ”¢ çŒœæ•¸å­—ï¼šä¸‰ä½ä¸€é«”é€²åŒ–ç‰ˆ")

    with gr.Row():
        mode_radio = gr.Radio(["ç¶“å…¸ç”Ÿå­˜æˆ°", "å±¬æ€§è§£ç¢¼æˆ°", "è‰²å½©åµæŸ¥æˆ°"], label="é¸æ“‡æŒ‘æˆ°æ¨¡å¼", value="ç¶“å…¸ç”Ÿå­˜æˆ°")
        stamina_radio = gr.Radio([15, 10, 5], label="é¸æ“‡åˆå§‹è¡€é‡ (é›£åº¦)", value=10)

    with gr.Row():
        with gr.Column(scale=2):
            display_panel = gr.Textbox(label="æˆ°è¡“æƒ…å ±é¡¯ç¤º", lines=15, interactive=False)
        with gr.Column(scale=1):
            odd_even_ui = gr.Radio(["å¥‡æ•¸", "å¶æ•¸"], label="å¥‡å¶é æ¸¬ (åƒ…å±¬æ€§è§£ç¢¼æˆ°é¦–å›åˆ)", visible=False)
            input_box = gr.Number(label="è¼¸å…¥ä½ çš„é æ¸¬å€¼", precision=0)
            btn_submit = gr.Button("æäº¤é æ¸¬", variant="primary")
            msg_label = gr.Label(label="åµæ¸¬åé¥‹")
            btn_reset = gr.Button("å¼·åˆ¶é‡ç½®éŠæˆ²")

    def update_ui_visibility(mode):
        return gr.update(visible=(mode == "å±¬æ€§è§£ç¢¼æˆ°"))

    mode_radio.change(update_ui_visibility, inputs=mode_radio, outputs=odd_even_ui)

    common_inputs = [input_box, mode_radio, stamina_radio, odd_even_ui]
    btn_submit.click(play_engine, inputs=common_inputs, outputs=[msg_label, display_panel])
    input_box.submit(play_engine, inputs=common_inputs, outputs=[msg_label, display_panel])
    
    def handle_reset(m, s): return game.reset(m, s)
    btn_reset.click(handle_reset, inputs=[mode_radio, stamina_radio], outputs=display_panel)
    mode_radio.change(handle_reset, inputs=[mode_radio, stamina_radio], outputs=display_panel)
    stamina_radio.change(handle_reset, inputs=[mode_radio, stamina_radio], outputs=display_panel)

    demo.load(lambda: game.get_ui_status(), outputs=display_panel)

demo.launch()
